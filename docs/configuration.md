# Charon Configuration

This document describes the configuration options for running a charon node and cluster locally or in production.

## Cluster Config Files

> Note this is for Charon V1 and extends on [DKG](dkg.md) docs. Charon V0 still uses old manifest files.

A charon cluster is configured in two steps:
- `cluster.json` which defines the cluster parameters without validator keys.
- `cluster.lock` which includes `cluster.json` and includes distributed validator keys.

The `charon create dkg` command is used to create `cluster.json` file which is used as input to `charon dkg`.

The `charon create cluster` command combines both steps into one and just outputs the final `cluster.lock` without a DKG step.

The schema of the `cluster.json` is defined as:
```json
{
  "version": "v1.0.0",                   // Schema version
  "num_validators": 100,                // Number of validators to create in cluster.lock
  "threshold": 3,                       // Optional threshold required for signature reconstruction
  "uuid": "1234-abcdef-1234-abcdef",    // Random unique identifier
  "name": "best cluster",               // Optional name field, cosmetic.
  "fee_recipient_address":"0x123..abfc",// ETH1 fee_recipient address
  "withdrawal_address": "0x123..abfc",  // ETH1 withdrawal address
  "algorithm": "foo_dkg_v1" ,           // Optional DKG algorithm
  "fork_version": "0x00112233",         // Fork version lock, enum of known values
  "operators": [
    {
      "address": "0x123..abfc",         // ETH1 operator identify address
      "enr": "enr://abcdef...12345",    // charon node ENR
      "signature": "123456...abcdef",   // Signature of enr by ETH1 address priv key
      "nonce": 1                        // Nonce of signature
    }
  ],
  "config_hash": "abcdef...abcedef"     // Hash of above field (except free text)
}
```

The above `cluster.json` is provided as input to the DKG which generates keys and the `cluster.lock` file.

The `cluster.lock` has the following schema:
```json
{
  "cluster_config": {...},  // Cluster json config, identical schema to above,
  "distributed_validators": [                               // Length equaled to num_validators.
    {
      "distributed_public_key":  "0x123..abfc",             // DV root pubkey
      "threshold_verifiers": [ "oA8Z...2XyT", "g1q...icu"], // length of threshold
      "fee_recipient": "0x123..abfc"                        // Defaults to withdrawal address if not set, can be edited manually
    }
  ],
  "lock_hash": "abcdef...abcedef",                          // Config_hash plus distributed_validators
  "config_hash_signature_aggregate": "abcdef...abcedef",    // DKG signs config with each DV pubkey, aggregates those for all DVs
}
```

`charon run` just requires a `cluster.lock` file to define the cluster.

Future work:
 - To add validators to a `cluster.lock`: look at adding migrations list `cluster.lock`?
 - Unique identifiers: each cluster.lock has path then derive ENRs from root `cluster.json` ENRs.

## Flag Precedence

Charon uses [viper](https://github.com/spf13/viper) for configuration combined with [cobra](https://github.com/spf13/cobra)
for cli commands.

In descending order, the Charon node checks the following places for configuration:
- From environment vars beginning with `CHARON_`, with hyphens substituted for underscores. e.g. `CHARON_BEACON_NODE=http://....`
- From the config file specified with the `-config-file` flag as YAML, e.g. `beacon-node: http://...`
- From CLI params, e.g. `--beacon-node http://...`

## Configuration Options
The following is the output of `charon run --help` and provides the available configuration options.

<!-- Code below generated by cmd/cmd_internal_test.go#TestConfigReference. DO NOT EDIT -->
````
Starts the long-running Charon middleware process to perform distributed validator duties.

Usage:
  charon run [flags]

Flags:
      --beacon-node-endpoint string    Beacon node endpoint URL (default "http://localhost/")
      --data-dir string                The directory where charon will store all its internal data (default "./charon/data")
  -h, --help                           Help for run
      --jaeger-address string          Listening address for jaeger tracing
      --jaeger-service string          Service name used for jaeger tracing (default "charon")
      --log-format string              Log format; console, logfmt or json (default "console")
      --log-level string               Log level; debug, info, warn or error (default "info")
      --manifest-file string           The path to the manifest file defining distributed validator cluster (default "./charon/manifest.json")
      --monitoring-address string      Listening address (ip and port) for the monitoring API (prometheus, pprof) (default "127.0.0.1:16001")
      --p2p-allowlist string           Comma-separated list of CIDR subnets for allowing only certain peer connections. Example: 192.168.0.0/16 would permit connections to peers on your local network only. The default is to accept all connections.
      --p2p-bootmanifest               Enables using manifest ENRs as discv5 bootnodes. Allows skipping explicit bootnodes if key generation ceremony included correct IPs.
      --p2p-bootnode-relay             Enables using bootnodes as libp2p circuit relays. Useful if some charon nodes are not have publicly accessible.
      --p2p-bootnodes strings          Comma-separated list of discv5 bootnode URLs or ENRs. Example: enode://<hex node id>@10.3.58.6:30303?discport=30301.
      --p2p-denylist string            Comma-separated list of CIDR subnets for disallowing certain peer connections. Example: 192.168.0.0/16 would disallow connections to peers on your local network. The default is to accept all connections.
      --p2p-external-hostname string   The DNS hostname advertised by libp2p. This may be used to advertise an external DNS.
      --p2p-external-ip string         The IP address advertised by libp2p. This may be used to advertise an external IP.
      --p2p-peerdb string              Path to store a discv5 peer database. Empty default results in in-memory database.
      --p2p-tcp-address strings        Comma-separated list of listening TCP addresses (ip and port) for libP2P traffic. (default [127.0.0.1:16003])
      --p2p-udp-address string         Listening UDP address (ip and port) for discv5 discovery. (default "127.0.0.1:16004")
      --simnet-beacon-mock             Enables an internal mock beacon node for running a simnet.
      --simnet-validator-mock          Enables an internal mock validator client when running a simnet. Requires simnet-beacon-mock.
      --validator-api-address string   Listening address (ip and port) for validator-facing traffic proxying the beacon-node API (default "127.0.0.1:16002")

````
<!-- Code above generated by cmd/cmd_internal_test.go#TestConfigReference. DO NOT EDIT -->
